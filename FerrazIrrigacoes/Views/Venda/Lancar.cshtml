<html>
<head>
    <title>Lançamento</title>
    <script src="~/Scripts/jquery-3.7.0.js"></script>
    <script type="text/javascript">

        $(document).ready(function () {
            $("#btnNovaVenda").click(function () {
                GerarNovaVenda(0);
            });
            $("#btnAddToList").click(function () {
                AdicionarProduto();
            });
            $("#btnFecharVenda").click(function () {
                FecharVenda();
            });
            $("#Produto").val(1);
            $("#Produto").change(function () {
                var ProdutoId = $("#Produto").val();
                BuscarValor(ProdutoId);
            })

            // Define a data e hora atuais no formato ISO para o campo "Data Venda"
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0'); // Mês é zero-indexado
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            const formattedDate = `${day}/${month}/${year}`;
            const formattHour = `${hours}:${minutes}`;
            $("#txtVenda").val(formattedDate);
            $("#txtHora").val(formattHour);

            // Display modal
            $("#btnShowModal").click(function () {
                mostrarDetalhesVenda();
                carregarFormasPagamento();
            });

            $("#txtDiscount").on('input', function () {
                atualizarValorFinal();
            });

            $(".close").click(function () {
                $('#divPagamento').modal('hide');
            });

            $(window).click(function (event) {
                if ($(event.target).is('#divPagamento')) {
                    $('#divPagamento').modal('hide');
                }
            });        

                $('#btnIncluirPagamento').click(function () {
                    var vendaId = parseInt($('#txtVendaI').val());
                    var clienteId = $('#Cliente').val();
                    var formaPagamentoId = $('#ddlPaymentMethod').val();
                    //var valor = $('#txtFinalValue').replace('.', ',').val(); //parseFloat($('#txtFinalValue').replace('.', ',').val());
                    var desconto = parseFloat($('#txtDiscount').val());
                    var maoDeObra = parseFloat($('#txtMaoDeObra').val());

                    var venda = {}
                    venda.Id = vendaId;
                    venda.ClienteId = clienteId;
                    venda.FormaDePagamento = formaPagamentoId;
                    venda.Valor = $('#txtFinalValue').val();
                    venda.Desconto = desconto;
                    venda.MaoDeObra = maoDeObra;


                    $.ajax({
                        url: '/Venda/FecharVenda',
                        type: 'POST',
                        data: venda,
                        success: function (data) {
                            if (data.sucesso) {
                                alert(data.mensagem);
                                window.location.href = '/Lancamento/Index'; // Redireciona para a lista de vendas
                            } else {
                                alert('Erro: ' + data.mensagem);
                            }
                        },
                        error: function () {
                            alert('Erro ao processar a venda');
                        }
                    });
                });
            
        });

        function mostrarDetalhesVenda() {
            var valorTotal = 0;
            $('#tbItens tbody tr').each(function () {
                var valorTotalCelula = $(this).find('td').eq(4).text(); // Índice da coluna Valor Total
                valorTotal += parseFloat(valorTotalCelula) || 0;
            });
            $('#txtTotalValue').val(valorTotal.toFixed(2));
            $('#divPagamento').attr('tabindex', "0");
            $('#divPagamento').modal('show');
        }

        function carregarFormasPagamento() {
            $.ajax({
                async: true,
                type: 'GET',
                dataType: 'JSON',
                contentType: 'application/json; charset=utf-8',
                url: '@Url.Action("ObterFormasPagamento", "Venda")',
                success: function (response) {
                    if (response.sucesso) {
                        var select = $('#ddlPaymentMethod');
                        select.empty();
                        $.each(response.formasPagamento, function (index, pagamento) {
                            select.append($('<option></option>').val(pagamento.id).text(pagamento.nome));
                        });
                    } else {
                        alert(response.mensagem);
                    }
                },
                error: function () {
                    alert("Erro ao buscar formas de pagamento.");
                }
            });
        }
        
        function atualizarValorFinal() {
            var total = parseFloat($('#txtTotalValue').val()) || 0;
            var desconto = parseFloat($('#txtDiscount').val()) || 0;
            var maoDeObra;
            
            if (desconto != 0)
            { 
                maoDeObra = parseFloat(total) * parseFloat(0.4);
            }
            else { 
                total = total - (total * (desconto / 100));
                maoDeObra = parseFloat(total)  * parseFloat(0.4);            
            }            
            

            $('#txtMaoDeObra').val(parseFloat(maoDeObra.toFixed(2)));

            var valorComMaoDeObra = parseFloat(total) + parseFloat(maoDeObra);
            var valorFinal = parseFloat(parseFloat(valorComMaoDeObra) - (parseFloat(valorComMaoDeObra) * (parseFloat(desconto) / 100)));

            $('#txtFinalValue').val(parseFloat(valorFinal.toFixed(2)));
        }

        function FecharVenda() {
            var VendaId = $("#txtVendaI").val();
            var ClienteId = $("#Cliente").val();

            if (!VendaId || VendaId == "0") {
                alert("Venda não foi gerada. Por favor, crie uma nova venda.");
                return;
            }

            if (!ClienteId || ClienteId == "0") {
                alert("Por favor, selecione um cliente.");
                return;
            }
            carregarFormasPagamento();
            mostrarDetalhesVenda();

        }

        function AdicionarProduto() {
            var VendaId = $("#txtVendaI").val();
            var ProdutoId = $("#Produto").val();
            var ProdutoNome = $("#Produto option:selected").text();
            var ProdutoValor = parseFloat($("#txtValorProduto").val());
            var Quantidade = parseInt($("#txtQuantidadeProduto").val());
            var TotalProdutos = (ProdutoValor * Quantidade).toFixed(2);

            var Item = {}
            Item.Venda = VendaId;
            Item.Produto = ProdutoId;
            Item.Quantidade = Quantidade;
            Item.ValorProduto = ProdutoValor;
            Item.ValorTotalProdutos = TotalProdutos;
            

            $.ajax({
                async: true,
                type: 'POST',
                dataType: 'JSON',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(Item),
                url: '/Venda/InserirItem',
                success: function () {
                    alert("Produto adicionado com sucesso!");
                },
                error: function (xhr, status, error) {
                    console.error("Erro ao adicionar o produto:", status, error);
                    alert("Erro ao adicionar o produto.");
                }
            });

            var newRow = $("<tr>");
            var cols = "";
            cols += '<td>' + ProdutoId + '</td>';
            cols += '<td>' + ProdutoNome + '</td>';
            cols += '<td>' + ProdutoValor.toFixed(2) + '</td>';
            cols += '<td>' + Quantidade + '</td>';
            cols += '<td>' + TotalProdutos + '</td>';
            // Exibir a quantidade
            cols += '<td class="actions">';
            cols += '<button class="btn btn-large btn-danger" onclick="RemoveTableRow(this)" type="button">Remover</button>';
            cols += '</td>';

            newRow.append(cols);
            $('#tbItens').append(newRow);
        }

        function RemoveTableRow(handler) {
            var tr = $(handler).closest('tr');

            tr.fadeOut(400, function () {
                tr.remove();
            });

            return false;
        }

        function BuscarValor(produtoId) {
            $.ajax({
                async: true,
                type: 'GET',
                dataType: 'JSON',
                contentType: 'application/json; charset=utf-8',
                data: { id: produtoId },
                url: '/Venda/BuscarValor',
                success: function (response) {
                    if (response.sucesso) {
                        $("#txtValorProduto").val(parseFloat(response.valor).toFixed(2));
                    } else {
                        alert(response.mensagem);
                    }
                },
                error: function () {
                    alert("Erro ao buscar o valor do produto.");
                }
            });
        }

        function GerarNovaVenda(Id) {
            $.ajax({
                async: true,
                type: 'GET',
                dataType: 'JSON',
                contentType: 'application/json; charset=utf-8',
                data: { Id: Id },
                url: '/Venda/GerarNovaVenda',
                success: function (data) {
                    console.log("Nova venda gerada com ID:", data);
                    $("#txtVendaI").val(parseInt(data));
                },
                error: function (xhr, status, error) {
                    console.error("Erro ao gerar nova venda:", status, error);
                    alert("Erro ao gerar nova venda.");
                }
            });
            }

    </script>
</head>
<body>
    <fieldset>
        <legend>Vendas</legend>
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <input type="button" style="margin-top: 20px" value="Nova Venda"
                               name="NovaVenda" id="btnNovaVenda" class="btn btn-success" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        Cliente:
                        @Html.DropDownList("Cliente", null, htmlAttributes: new { @class = "form-control" })
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        Venda:
                        <input type="text"  id="txtVendaI" value="0" name="VendaI" class="form-control" />
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        Data Venda:
                        <input type="datetime" id="txtVenda" value="10/05/2022" name="dtVenda" class="form-control" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        Devolução:
                        <input type="datetime" id="txtDevolucao" value="10/05/2022" name="Devolucao" class="form-control" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <input type="button" style="margin-top: 20px" id="btnFecharVenda" value="Fechar Venda" class="btn btn-success" />
                    </div>
                </div>
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend>Itens da Venda</legend>
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        Produto:
                        @Html.DropDownList("Produto", null, htmlAttributes: new { @class = "form-control" })
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        Valor:
                        <input type="number" id="txtValorProduto" name="txtValorProduto" class="form-control" placeholder="Valor do Produto" readonly />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        Quantidade:
                        <input type="number" id="txtQuantidadeProduto" name="txtQuantidadeProduto" class="form-control" placeholder="Quantidade" value="1" min="1" />
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <input type="button" style="margin-top: 20px" value="Adicionar" name="AddToList" id="btnAddToList" class="btn btn-success" />
                    </div>
                </div>
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend>Itens Vendidos</legend>
        <table style="width:100%" id="tbItens">
            <thead>
                <tr>
                    <th hidden>Item</th>
                    <th>Id</th>
                    <th>Produtos</th>
                    <th>Valor Unitário</th>
                    <th>Quantidade</th>
                    <th>Valor Total</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </fieldset>

    <div id="divPagamento" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Pagamento</h4>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <div>
                            <label>Forma de pagamento:</label>
                            <select id="ddlPaymentMethod">
                            </select>
                        </div>
                        <div>
                            <label>Valor Total:</label>
                            <input type="text" id="txtTotalValue" readonly />
                        </div>
                        <div>
                            <label>Desconto (%):</label>
                            <input type="text" id="txtDiscount" onkeyup="atualizarValorFinal()" />
                        </div>
                        <div>
                            <label>Mão de Obra (40%):</label>
                            <input type="text" id="txtMaoDeObra" readonly />
                        </div>
                        <div>
                            <label>Valor Final:</label>
                            <input type="text" id="txtFinalValue" readonly />
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" id="btnIncluirPagamento">Adicionar</button>
                    <button class="btn btn-danger" id="btnClose" data-dismiss="modal" value="close">Fechar</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
